<!DOCTYPE html>
<html>
    <head>
        <title>The Black Car Service</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link rel="stylesheet" href="map.css" />

        <meta charset="utf-8">
          <script src="http://maps.google.com/maps/api/js?key=AIzaSyB_KqNp8ZNTxst1EAAr4tSopPyEDYdZF5s&libraries=geometry"></script>
    <script>
        var myLat = 0;
        var myLng = 0;
     
        var me = new google.maps.LatLng(myLat, myLng);

        var infowindow = new google.maps.InfoWindow();
        // SET UP MAP
        var myOptions = {
            zoom: 15, // The larger the zoom number, the bigger the zoom
            center: me,
            //mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;

  
        function init() {
            console.log("init function")
            map = new google.maps.Map(document.getElementById('map'), myOptions);
            getMyLocation();
           
        }

        function getMyLocation() {
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(function(position){
                        myLat = position.coords.latitude;
                        myLng = position.coords.longitude;
                        renderMap();
                });
            }
            else {
                alert("Geolocation is not supported by your web browser.  What a shame!");
            }
        }

        function renderMap() {
            me = new google.maps.LatLng(myLat, myLng);

            map.panTo(me);

            var myIcon = new google.maps.MarkerImage
            (
                "target.png",
                null,
                null,
                null,
                new google.maps.Size(30, 40)
            );
                
            // Create a marker
            var marker = new google.maps.Marker({
              position: me,
              icon: myIcon,
              title: "pD0kGOax"
            });

            marker.setMap(map);

            
            google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(marker.title);
                    infowindow.open(map, marker);
            });
            getData();
        }

        function getData(){
            console.log("figureshitout function")

            // CONCATENATE MY INFO
            var parameters = "username=pD0kGOax&lat=" + myLat + "&lng=" + myLng;

            // START XML REQUEST
            xhr = new XMLHttpRequest();

            xhr.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            
            xhr.onreadystatechange = parseCarData;
      
            xhr.send(parameters);
        }

        function parseCarData() {
            console.log("parse car data")
            if (xhr.readyState == 4 && xhr.status == 200) {
                elements =  [];
                elements = JSON.parse(xhr.responseText);
                
                console.log(elements);
                
                var type;

                if(elements.passengers) {
                    type = elements.passengers;
                }
                else{
                    type = elements.vehicles;
                }

                for (i = 0; i < type.length; i++) {
                    // get all data + info
                    var xLat = type[i]['lat'];
                    var xLng = type[i]['lng'];

                    var xLatLng = new google.maps.LatLng(xLat, xLng);

                    var xUsername = type[i]['username'];
                    console.log(xUsername);

                    var meterDist = google.maps.geometry.spherical.computeDistanceBetween(me, xLatLng);
                    var mileDist = meterDist/1609;

                    // place correct markers on map
                    if (elements.passengers) { 
                        var passenger = new google.maps.MarkerImage
                        (
                            "passenger.png",
                            null,
                            null,
                            null,
                            new google.maps.Size(30, 40)
                        );
                        var marker = new google.maps.Marker({
                            position: xLatLng,
                            map: map,
                            icon: passenger,
                            title: xUsername + " is " + mileDist + " miles away.",
                        });

                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.setContent(this.title);
                            infowindow.open(map, this);
                        });
                        marker.setMap(map);
                    } else {
                        var vehicle = new google.maps.MarkerImage
                        (
                            "black_car.png",
                            null,
                            null,
                            null,
                            new google.maps.Size(30, 40)
                        );
                        var marker = new google.maps.Marker({
                            position: xLatLng,
                            map: map,
                            icon: vehicle,
                            title: xUsername + " is " + mileDist + " miles away.",
                        });

                        google.maps.event.addListener(marker, 'click', function() {
                            infowindow.setContent(this.title);
                            infowindow.open(map, this);
                        });
                        marker.setMap(map);
                    }
                }
            }    
        }

        
        
/*      
    SCRATCHWORK
   if(xUsername == myUsername) { // it's me!
                        console.log("found me");
                        var myIcon = new google.maps.MarkerImage
                        (
                            "mymarker.png",
                            null,
                            null,
                            null,
                            new google.maps.Size(30, 40)
                        );
                        var marker = new google.maps.Marker({
                           position: me,
                           icon: myIcon,
                        });
                        marker.setMap(map); 



                        var xLat = type[i]['lat'];
                        var xLng = elements.vehicles[i]['lng'];

                        var xLatLng = new google.maps.LatLng(xLat, xLng);

                        var xUsername = elements.vehicles[i]['username'];
                        console.log(xUsername);

                        var meterDist = google.maps.geometry.spherical.computeDistanceBetween(me, xLatLng);
                        var mileDist = meterDist/1609;
    

*/
    </script>
    </head>
  <body onload = "init()">
    <div id="map"></div>
    

</body>
</html>