<!DOCTYPE html>
<html>
    <head>
        <title>The Black Car Service</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link rel="stylesheet" href="map.css" />

        <meta charset="utf-8">
    </head>
  <body onload = "init()">
    <div id="map"></div>
      <script src="http://maps.google.com/maps/api/js?key=AIzaSyB_KqNp8ZNTxst1EAAr4tSopPyEDYdZF5s&sensor=true"></script>
    <script>
        var myLat = 0;
        var myLng = 0;
     
        var me = new google.maps.LatLng(myLat, myLng);

        // SET UP MAP
        var myOptions = {
            zoom: 8, // The larger the zoom number, the bigger the zoom
            center: me,
            //mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;
        //var infowindow = new google.maps.InfoWindow();

  
        function init() {
            console.log("init function")
            map = new google.maps.Map(document.getElementById('map'), myOptions);

            var myIcon = "mymarker.png"
            // Create a marker
            var marker = new google.maps.Marker({
              position: me,
              icon: myIcon,
              title: "Here I Am!"
            });

            marker.setMap(map);

            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(FIGURESHITOUT);
            }
            else {
                alert("Geolocation is not supported by your web browser.  What a shame!");
            }
        }

        function FIGURESHITOUT(position){
            console.log("figureshitout function")
            // GET MY COORDINATES
            myLat = position.coords.latitude;
            myLng = position.coords.longitude;

            // PAN TO ME
            me = new google.maps.LatLng(myLat, myLng);
            map.panTo(me);

            // CONCATENATE MY INFO
            var parameters = "username=pD0kGOax&lat=" + myLat + "&lng=" + myLng;

            // START XML REQUEST
            xhr = new XMLHttpRequest();

            xhr.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            
            xhr.onreadystatechange = parseCarData;
      
            xhr.send(parameters);
        }

        function parseCarData() {
            console.log("parse car data")
            if (xhr.readyState == 4 && xhr.status == 200) {
                elements = JSON.parse(xhr.responseText);
                var test = elements[1].lat;
                console.log(test);
                
                //console.log(elements);
               
                for (i = 0; i < 54; i++) {
                    
                    //console.log("in loop")
                    var xLat = elements[i]['lat'];
                    var xLng = elements[i]['lng'];

                    var xLatLng = new google.maps.LatLng(xLat, xLng);

                    var xUsername = elements[i]['username'];

                    if(xUsername = "pD0kGOax") { // it's me!
                        console.log("found me");
                        var myIcon = "mymarker.png"
                        var marker = new google.maps.Marker({
                           position: me,
                           icon: myIcon,
                        });
                        marker.setMap(map);
                    }
                    // not me!
                    var vehicle = "vehicle.png"
                    var marker = new google.maps.Marker({
                        position: aLatLng,
                        map: map,
                        icon: vehicle,
                        title: xUsername + ". Distance from me: " + distanceFromMe(aLat, aLng) + " miles."
                    });
                    marker.setMap(map);
                }
                
            }
        }
      
        


    </script>

</body>
</html>