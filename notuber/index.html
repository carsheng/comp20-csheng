<!DOCTYPE html>
<html>
    <head>
        <title>The Black Car Service</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link rel="stylesheet" href="map.css" />

        <meta charset="utf-8">
          <script src="http://maps.google.com/maps/api/js?key=AIzaSyB_KqNp8ZNTxst1EAAr4tSopPyEDYdZF5s&sensor=true"></script>
    <script>
        var myLat = 0;
        var myLng = 0;
     
        var me = new google.maps.LatLng(myLat, myLng);

        // SET UP MAP
        var myOptions = {
            zoom: 12, // The larger the zoom number, the bigger the zoom
            center: me,
            //mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;
        //var infowindow = new google.maps.InfoWindow();

  
        function init() {
            console.log("init function")
            map = new google.maps.Map(document.getElementById('map'), myOptions);
            getMyLocation();
           
        }

        function getMyLocation() {
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(function(position){
                        myLat = position.coords.latitude;
                        myLng = position.coords.longitude;
                        renderMap();
                });
            }
            else {
                alert("Geolocation is not supported by your web browser.  What a shame!");
            }
        }

        function renderMap() {
            me = new google.maps.LatLng(myLat, myLng);

            map.panTo(me);

            var myIcon = new google.maps.MarkerImage
            (
                "bluepin.png",
                null,
                null,
                null,
                new google.maps.Size(30, 40)
            );
                
            // Create a marker
            var marker = new google.maps.Marker({
              position: me,
              icon: myIcon,
              title: "Here I Am!"
            });

            marker.setMap(map);
            FIGURESHITOUT();
        }

        function FIGURESHITOUT(){
            console.log("figureshitout function")

            // CONCATENATE MY INFO
            var parameters = "username=pD0kGOax&lat=" + myLat + "&lng=" + myLng;

            // START XML REQUEST
            xhr = new XMLHttpRequest();

            xhr.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            
            xhr.onreadystatechange = parseCarData;
      
            xhr.send(parameters);
        }

        function parseCarData() {
            console.log("parse car data")
            if (xhr.readyState == 4 && xhr.status == 200) {
                elements = JSON.parse(xhr.responseText);
                var test = elements.passengers[1].lat;
                console.log(test);
                
                //console.log(elements);
               
                for (i = 0; i < 54; i++) {
                    
                    //console.log("in loop")
                    var xLat = elements.passengers[i]['lat'];
                    var xLng = elements.passengers[i]['lng'];

                    var xLatLng = new google.maps.LatLng(xLat, xLng);

                    var xUsername = elements.passengers[i]['username'];

                    var myUsername = "pD0kGOax";
                    
                  
                        console.log("not me!");
                        var passenger = new google.maps.MarkerImage
                        (
                            "passenger.png",
                            null,
                            null,
                            null,
                            new google.maps.Size(30, 40)
                        );
                        var marker = new google.maps.Marker({
                            position: xLatLng,
                            map: map,
                            icon: passenger,
                            title: xUsername,
                        });
                        marker.setMap(map);
                    }
                }
                
            }
        
/*      
   if(xUsername == myUsername) { // it's me!
                        console.log("found me");
                        var myIcon = new google.maps.MarkerImage
                        (
                            "mymarker.png",
                            null,
                            null,
                            null,
                            new google.maps.Size(30, 40)
                        );
                        var marker = new google.maps.Marker({
                           position: me,
                           icon: myIcon,
                        });
                        marker.setMap(map);     

*/
    </script>
    </head>
  <body onload = "init()">
    <div id="map"></div>
    

</body>
</html>